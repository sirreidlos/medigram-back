<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="consent-protocol-specification">Consent Protocol Specification</h1>
<pre class=" language-mermaid"><svg id="mermaid-svg-5FKJGevItVTsfqRw" width="100%" xmlns="http://www.w3.org/2000/svg" height="557" style="max-width: 661px;" viewBox="-50 -10 661 557"><style>#mermaid-svg-5FKJGevItVTsfqRw{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#000000;}#mermaid-svg-5FKJGevItVTsfqRw .error-icon{fill:#552222;}#mermaid-svg-5FKJGevItVTsfqRw .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-5FKJGevItVTsfqRw .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-5FKJGevItVTsfqRw .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-5FKJGevItVTsfqRw .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-5FKJGevItVTsfqRw .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-5FKJGevItVTsfqRw .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-5FKJGevItVTsfqRw .marker{fill:#666;stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw .marker.cross{stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-5FKJGevItVTsfqRw .actor{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-5FKJGevItVTsfqRw text.actor > tspan{fill:#333;stroke:none;}#mermaid-svg-5FKJGevItVTsfqRw .actor-line{stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-svg-5FKJGevItVTsfqRw .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-svg-5FKJGevItVTsfqRw #arrowhead path{fill:#333;stroke:#333;}#mermaid-svg-5FKJGevItVTsfqRw .sequenceNumber{fill:white;}#mermaid-svg-5FKJGevItVTsfqRw #sequencenumber{fill:#333;}#mermaid-svg-5FKJGevItVTsfqRw #crosshead path{fill:#333;stroke:#333;}#mermaid-svg-5FKJGevItVTsfqRw .messageText{fill:#333;stroke:#333;}#mermaid-svg-5FKJGevItVTsfqRw .labelBox{stroke:hsl(0,0%,83%);fill:#eee;}#mermaid-svg-5FKJGevItVTsfqRw .labelText,#mermaid-svg-5FKJGevItVTsfqRw .labelText > tspan{fill:#333;stroke:none;}#mermaid-svg-5FKJGevItVTsfqRw .loopText,#mermaid-svg-5FKJGevItVTsfqRw .loopText > tspan{fill:#333;stroke:none;}#mermaid-svg-5FKJGevItVTsfqRw .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(0,0%,83%);fill:hsl(0,0%,83%);}#mermaid-svg-5FKJGevItVTsfqRw .note{stroke:hsl(60,100%,23.3333333333%);fill:#ffa;}#mermaid-svg-5FKJGevItVTsfqRw .noteText,#mermaid-svg-5FKJGevItVTsfqRw .noteText > tspan{fill:#333;stroke:none;}#mermaid-svg-5FKJGevItVTsfqRw .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-svg-5FKJGevItVTsfqRw:root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-svg-5FKJGevItVTsfqRw sequence{fill:apa;}</style><g></g><g><line id="actor628" x1="75" y1="5" x2="75" y2="546" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">Patient</tspan></text></g><g><line id="actor629" x1="275" y1="5" x2="275" y2="546" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">Doctor</tspan></text></g><g><line id="actor630" x1="481" y1="5" x2="481" y2="546" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="406" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="481" y="32.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="481" dy="0">Server</tspan></text></g><defs><marker id="arrowhead" refX="9" refY="5" markerUnits="userSpaceOnUse" markerWidth="12" markerHeight="12" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" style="stroke-dasharray: 0px, 0px;" stroke-width="1px" d="M 9,2 V 6 L16,4 Z"></path><path fill="none" stroke="#000000" style="stroke-dasharray: 0px, 0px;" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7"></path></marker></defs><defs><marker id="filled-head" refX="18" refY="7" markerWidth="20" markerHeight="28" orient="auto"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><g><rect x="70" y="65" fill="#EDF2AE" stroke="#666" width="10" height="222" rx="0" ry="0" class="activation0"></rect></g><g><rect x="476" y="67" fill="#EDF2AE" stroke="#666" width="10" height="94" rx="0" ry="0" class="activation0"></rect></g><text x="278" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">requestNonce</text><line x1="80" y1="113" x2="476" y2="113" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;" marker-end="url(#arrowhead)"></line><text x="278" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">return</text><line x1="476" y1="161" x2="80" y2="161" style="stroke-dasharray: 3px, 3px; fill: none;" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)"></line><text x="80" y="176" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">signMessage</text><path d="M 80,209 C 140,199 140,239 80,229" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;" marker-end="url(#arrowhead)"></path><g><rect x="270" y="241" fill="#EDF2AE" stroke="#666" width="10" height="46" rx="0" ry="0" class="activation0"></rect></g><text x="175" y="254" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">showQRCode</text><line x1="80" y1="287" x2="270" y2="287" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;" marker-end="url(#arrowhead)"></line><g><rect x="270" y="287" fill="#EDF2AE" stroke="#666" width="10" height="174" rx="0" ry="0" class="activation0"></rect></g><g><rect x="476" y="289" fill="#EDF2AE" stroke="#666" width="10" height="172" rx="0" ry="0" class="activation0"></rect></g><text x="378" y="302" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">newMedicalRecord</text><line x1="280" y1="335" x2="476" y2="335" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;" marker-end="url(#arrowhead)"></line><text x="486" y="350" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">verifySignature</text><path d="M 486,383 C 546,373 546,413 486,403" class="messageLine0" stroke-width="2" stroke="none" style="fill: none;" marker-end="url(#arrowhead)"></path><text x="378" y="428" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" style="font-family: &quot;trebuchet ms&quot;, verdana, arial, sans-serif; font-weight: 400;" class="messageText" dy="1em">return</text><line x1="476" y1="461" x2="280" y2="461" style="stroke-dasharray: 3px, 3px; fill: none;" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)"></line><g><rect x="0" y="481" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="513.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="75" dy="0">Patient</tspan></text></g><g><rect x="200" y="481" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="513.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="275" dy="0">Doctor</tspan></text></g><g><rect x="406" y="481" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="481" y="513.5" style="text-anchor: middle; font-weight: 400; font-family: &quot;Open-Sans&quot;, &quot;sans-serif&quot;;" dominant-baseline="central" alignment-baseline="central" class="actor"><tspan x="481" dy="0">Server</tspan></text></g></svg></pre>
<h2 id="dependencies">Dependencies</h2>
<ul>
<li>Ed25519 for cryptographic signature</li>
<li>Canonical JSON compliant encoder for message formatting</li>
</ul>
<h2 id="keys">Keys</h2>
<p>Upon logging in, a client will be provided a private key for them to use encoded in base64. The secret key is solely tied to the device they logged onto, as there’s no safe way to redistribute previously generated keys. The client should store the secret key in a secure storage.</p>
<p>The server should also store the public key tied to the device id in a storage.</p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
  <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"41676bb2-8561-47fe-9271-4c7e89defa7c"</span><span class="token punctuation">,</span>
  <span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"xgsY0ovfKCqpfLHfCZCSaI0AVHt2e6Xnv76VyvXsyJVsKsu89UjdDEWIU9k7IGmc"</span><span class="token punctuation">,</span>
  <span class="token string">"token_type"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token string">"device_id"</span><span class="token punctuation">:</span> <span class="token string">"19553e8e-b9bb-4af6-b73a-448e01103125"</span><span class="token punctuation">,</span>
  <span class="token string">"private_key"</span><span class="token punctuation">:</span> <span class="token string">"y0eJbsKqY7so2gNwAQ0M0ZlM0... [PRIVATE KEY IN BASE64 STRING]"</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="message">Message</h2>
<p>The message signed is in the form of a canonical JSON array that has the device id as the first item in the array, and the nonce as the second item in the array. Here’s what the message would look like:</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">let</span> uuid <span class="token operator">=</span> uuid<span class="token punctuation">:</span><span class="token punctuation">:</span>Uuid<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse_str</span><span class="token punctuation">(</span><span class="token string">"3eeac678-f795-4089-835d-ad394dc9c2e9"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> json <span class="token operator">=</span> serde_json_canonicalizer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> <span class="token string">"drFvd68nqT6TFhoc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "[\"3eeac678-f795-4089-835d-ad394dc9c2e9\",\"drFvd68nqT6TFhoc\"]"</span>
</code></pre>
<h2 id="consent">Consent</h2>
<p>The consent sent to the server should be in the format like below. The signature being a base64 encoded text of the signature.</p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
  <span class="token string">"signer_device_id"</span><span class="token punctuation">:</span> <span class="token string">"3eeac678-f795-4089-835d-ad394dc9c2e9"</span><span class="token punctuation">,</span>
  <span class="token string">"nonce"</span><span class="token punctuation">:</span> <span class="token string">"drFvd68nqT6TFhoc"</span><span class="token punctuation">,</span>
  <span class="token string">"signature"</span><span class="token punctuation">:</span> <span class="token string">"l1N5JcGJSnMlrG/IaITRvbqZIaBraCseFoBg/Te7cX7hqUXUtTKsVXpNuBpeH9YV/nMKquJZlyz+JjS4a08zCA=="</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="qr">QR</h2>
<p>The QR code shown to the doctor should encode the consent struct from above. The task of the doctor client would be to parse it and then send it alongside the other data from the consultation to the server.</p>
<pre class=" language-json"><code class="prism  language-json"><span class="token punctuation">{</span>
  <span class="token string">"consent"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"signer_device_id"</span><span class="token punctuation">:</span> <span class="token string">"3eeac678-f795-4089-835d-ad394dc9c2e9"</span><span class="token punctuation">,</span>
    <span class="token string">"nonce"</span><span class="token punctuation">:</span> <span class="token string">"drFvd68nqT6TFhoc"</span><span class="token punctuation">,</span>
    <span class="token string">"signature"</span><span class="token punctuation">:</span> <span class="token string">"l1N5JcGJSnMlrG/IaITRvbqZIaBraCseFoBg/Te7cX7hqUXUtTKsVXpNuBpeH9YV/nMKquJZlyz+JjS4a08zCA=="</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"3fa85f64-5717-4562-b3fc-2c963f66afa6"</span><span class="token punctuation">,</span>
  <span class="token string">"location_id"</span><span class="token punctuation">:</span> <span class="token string">"3fa85f64-5717-4562-b3fc-2c963f66afa6"</span><span class="token punctuation">,</span>
  <span class="token string">"diagnoses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"diagnosis"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
      <span class="token string">"severity"</span><span class="token punctuation">:</span> <span class="token string">"MILD"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"symptoms"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token string">"prescriptions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"drug_name"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
      <span class="token string">"doses_in_mg"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"regimen_per_day"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"quantity_per_dose"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"instruction"</span><span class="token punctuation">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="verify-signature">Verify Signature</h2>
<p>Example of signing and verifying process:</p>
<pre class=" language-rust"><code class="prism  language-rust"><span class="token keyword">let</span> sk <span class="token operator">=</span> ed25519_compact<span class="token punctuation">:</span><span class="token punctuation">:</span>SecretKey<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key_bytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pk <span class="token operator">=</span> sk<span class="token punctuation">.</span><span class="token function">public_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> consent <span class="token operator">=</span> sk<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>json<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{consent:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [97, 53, 79, 25, c1, 89, 4a, 73, 25, ac, 6f, c8, 68, 84, d1, bd, ba, 99, 21, a0, 6b, 68, 2b, 1e, 16, 80, 60, fd, 37, bb, 71, 7e, e1, a9, 45, d4, b5, 32, ac, 55, 7a, 4d, b8, 1a, 5e, 1f, d6, 15, fe, 73, a, aa, e2, 59, 97, 2c, fe, 26, 34, b8, 6b, 4f, 33, 8]</span>

<span class="token keyword">let</span> consent_str <span class="token operator">=</span> base64<span class="token punctuation">:</span><span class="token punctuation">:</span>engine<span class="token punctuation">:</span><span class="token punctuation">:</span>general_purpose<span class="token punctuation">:</span><span class="token punctuation">:</span>STANDARD<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>consent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{consent_str}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// l1N5JcGJSnMlrG/IaITRvbqZIaBraCseFoBg/Te7cX7hqUXUtTKsVXpNuBpeH9YV/nMKquJZlyz+JjS4a08zCA==</span>

<span class="token comment">// Verify signature</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> pk<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token operator">&amp;</span>consent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ok(())</span>
</code></pre>
</div>
</body>

</html>

